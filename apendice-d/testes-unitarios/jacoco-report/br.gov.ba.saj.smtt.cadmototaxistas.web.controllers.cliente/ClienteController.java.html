<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClienteController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cadmototaxistas</a> &gt; <a href="index.source.html" class="el_package">br.gov.ba.saj.smtt.cadmototaxistas.web.controllers.cliente</a> &gt; <span class="el_source">ClienteController.java</span></div><h1>ClienteController.java</h1><pre class="source lang-java linenums">package br.gov.ba.saj.smtt.cadmototaxistas.web.controllers.cliente;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.function.Consumer;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.User;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import br.gov.ba.saj.smtt.cadmototaxistas.auditoria.model.entities.RegistroClienteContato;
import br.gov.ba.saj.smtt.cadmototaxistas.auditoria.service.RegistroClienteContato.RegistroClienteContatoService;
import br.gov.ba.saj.smtt.cadmototaxistas.model.entities.Cliente;
import br.gov.ba.saj.smtt.cadmototaxistas.model.entities.Condutor;
import br.gov.ba.saj.smtt.cadmototaxistas.security.model.entities.Usuario;
import br.gov.ba.saj.smtt.cadmototaxistas.security.services.usuario.UsuarioService;
import br.gov.ba.saj.smtt.cadmototaxistas.service.cliente.ClienteService;
import br.gov.ba.saj.smtt.cadmototaxistas.service.condutor.CondutorService;
import br.gov.ba.saj.smtt.cadmototaxistas.service.validacao.ValidadorDeContatoService;
import br.gov.ba.saj.smtt.cadmototaxistas.util.messages.UtilMessage;
import br.gov.ba.saj.smtt.cadmototaxistas.util.paginacao.PaginacaoUtil;
import br.gov.ba.saj.smtt.cadmototaxistas.web.controllers.condutor.CondutorController;
import jakarta.validation.Valid;

/**
 * Controller responsável pelo gerenciamento das operações relacionadas aos
 * clientes.
 *
 * Oferece funcionalidades para visualização, cadastro e edição dos dados
 * pessoais do cliente
 * autenticado. Utiliza os serviços de {@link ClienteService} e
 * {@link UsuarioService} para
 * persistência e recuperação de dados.
 */
@Controller
@RequestMapping(&quot;/clientes&quot;)
<span class="fc" id="L54">public class ClienteController {</span>

<span class="fc" id="L56">  private static final Logger LOGGER = LoggerFactory.getLogger(CondutorController.class);</span>

  @Autowired
  private ClienteService clienteService;

  @Autowired
  private CondutorService condutorService;

  @Autowired
  private ValidadorDeContatoService validadorDeContatoService;

  @Autowired
  private RegistroClienteContatoService registroClienteContatoService;

  /**
   * Exibe o formulário com os dados pessoais do cliente.
   *
   * @param model objeto para envio de atributos à view
   * @param user  usuário autenticado
   * @return página de cadastro do cliente
   */
  @GetMapping(&quot;/dados&quot;)
  public String cadastrar(ModelMap model, @AuthenticationPrincipal User user) {
<span class="nc" id="L79">    Cliente cliente = clienteService.buscarPorUsuarioEmail(user.getUsername())</span>
<span class="nc" id="L80">        .orElseGet(() -&gt; new Cliente(new Usuario(user.getUsername())));</span>
<span class="nc" id="L81">    model.addAttribute(&quot;cliente&quot;, cliente);</span>
<span class="nc" id="L82">    LOGGER.info(&quot;Exibindo formulário de dados do cliente: {}&quot;, user.getUsername());</span>
<span class="nc" id="L83">    return &quot;cliente/cadastro&quot;;</span>
  }

  /**
   * Salva os dados pessoais do cliente após validação da senha feito pelo método
   * salvar().
   *
   * @param cliente objeto com os dados do formulário
   * @param model   objeto para envio de atributos à view
   * @param user    usuário autenticado
   * @return página de cadastro com feedback de sucesso ou erro
   */
  /**
   * Processa o envio do formulário de cadastro/edição de cliente.
   *
   * @param cliente cliente preenchido no formulário
   * @param result  resultado da validação dos dados
   * @param model   modelo de dados para a view
   * @param user    usuário autenticado
   * @return nome da view
   */
  @PostMapping(&quot;/salvar&quot;)
  public String salvar(@Valid Cliente cliente, BindingResult result, ModelMap model,
      @AuthenticationPrincipal User user) {

<span class="nc" id="L108">    List&lt;String&gt; erros = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">    if (validadorDeContatoService.existeTelefoneCadastrado(cliente)) {</span>
<span class="nc" id="L111">      erros.add(&quot;Telefone já utilizado por outro contato.&quot;);</span>
    }

<span class="nc" id="L114">    boolean erro = UtilMessage.temErro(result, model, LOGGER, user, erros,</span>
<span class="nc" id="L115">        res -&gt; &quot;Erro ao validar os dados do cliente.&quot;);</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">    if (erro) {</span>
<span class="nc" id="L118">      model.addAttribute(&quot;cliente&quot;, cliente);</span>
<span class="nc" id="L119">      return &quot;cliente/cadastro&quot;;</span>
    }

<span class="nc" id="L122">    boolean sucesso = clienteService.salvar(cliente, user);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    if (sucesso) {</span>
<span class="nc" id="L124">      UtilMessage.adicionarMensagemSucesso(model, &quot;Seus dados foram inseridos com sucesso.&quot;);</span>
<span class="nc" id="L125">      model.addAttribute(&quot;cliente&quot;, cliente);</span>
    } else {
<span class="nc" id="L127">      UtilMessage.adicionarMensagemErro(model, &quot;Sua senha não confere, tente novamente.&quot;);</span>
    }
<span class="nc" id="L129">    return &quot;cliente/cadastro&quot;;</span>
  }

  /**
   * Edita os dados pessoais do cliente após validação da senha feito pelo método
   * editar().
   *
   * @param cliente objeto com os dados do formulário
   * @param model   objeto para envio de atributos à view
   * @param user    usuário autenticado
   * @return página de cadastro com feedback de sucesso ou erro
   */
  @PostMapping(&quot;/editar&quot;)
  public String editar(Cliente cliente, ModelMap model, @AuthenticationPrincipal User user) {
<span class="nc" id="L143">    boolean sucesso = clienteService.editar(cliente, user);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">    Consumer&lt;ModelMap&gt; resposta = sucesso</span>
<span class="nc" id="L145">        ? m -&gt; {</span>
<span class="nc" id="L146">          UtilMessage.adicionarMensagemSucesso(m, &quot;Seus dados foram editados com sucesso.&quot;);</span>
<span class="nc" id="L147">          m.addAttribute(&quot;cliente&quot;, cliente);</span>
<span class="nc" id="L148">          LOGGER.info(&quot;Cliente editado com sucesso: {}&quot;, user.getUsername());</span>
<span class="nc" id="L149">        }</span>
<span class="nc" id="L150">        : m -&gt; {</span>
<span class="nc" id="L151">          UtilMessage.adicionarMensagemErro(m, &quot;Sua senha não confere, tente novamente.&quot;);</span>
<span class="nc" id="L152">          LOGGER.warn(&quot;Falha na confirmação de senha ao editar cliente: {}&quot;, user.getUsername());</span>
<span class="nc" id="L153">        };</span>
<span class="nc" id="L154">    resposta.accept(model);</span>
<span class="nc" id="L155">    return &quot;cliente/cadastro&quot;;</span>
  }

  /**
   * Exibe a lista de condutores ativos para o cliente autenticado.
   * 
   * &lt;p&gt;
   * Verifica se o cliente associado ao usuário autenticado possui os dados
   * pessoais preenchidos.
   * Caso contrário, redireciona para a página de preenchimento dos dados do
   * cliente com uma mensagem de alerta.
   * &lt;/p&gt;
   * 
   * &lt;p&gt;
   * Se os dados estiverem preenchidos, busca todos os condutores ativos e
   * adiciona na model para exibição.
   * &lt;/p&gt;
   * 
   * @param model objeto ModelMap usado para enviar atributos para a view.
   * @param user  usuário autenticado obtido pelo Spring Security.
   * @param attr  RedirectAttributes para adicionar mensagens flash em caso de
   *              redirecionamento.
   * @return nome da view que exibirá a lista de condutores ou redirecionamento
   *         para a página de dados do cliente.
   */
  @GetMapping(&quot;/condutores&quot;)
  @PreAuthorize(&quot;hasAuthority('CLIENTE')&quot;)
  public String listarCondutoresParaCliente(ModelMap model, @RequestParam(&quot;page&quot;) Optional&lt;Integer&gt; page,
      @RequestParam(&quot;dir&quot;) Optional&lt;String&gt; dir, @AuthenticationPrincipal User user,
      RedirectAttributes attr) {
<span class="nc" id="L185">    Optional&lt;Cliente&gt; cliente = clienteService.buscarPorUsuarioEmail(user.getUsername());</span>

<span class="nc bnc" id="L187" title="All 4 branches missed.">    if (cliente.isEmpty() || cliente.get().getNome() == null) {</span>
<span class="nc" id="L188">      attr.addFlashAttribute(&quot;fail&quot;, &quot;Você precisa preencher seus dados antes de visualizar os mototaxistas.&quot;);</span>
<span class="nc" id="L189">      return &quot;redirect:/clientes/dados&quot;;</span>
    }

<span class="nc" id="L192">    int paginaAtual = page.orElse(1);</span>
<span class="nc" id="L193">    String ordem = dir.orElse(&quot;asc&quot;);</span>
<span class="nc" id="L194">    PaginacaoUtil&lt;Condutor&gt; pageCondutor = condutorService.buscaPaginada(paginaAtual, ordem, true);</span>
<span class="nc" id="L195">    model.addAttribute(&quot;pageCondutor&quot;, pageCondutor);</span>
<span class="nc" id="L196">    return &quot;cliente/lista-condutores&quot;;</span>
  }

  /**
   * Filtra a lista de condutores pelo número de ordem.
   */
  @GetMapping(&quot;/buscar/numero-de-ordem&quot;)
  public String getCondutorPorNumOrdem(@RequestParam(&quot;numOrdem&quot;) String numOrdem, ModelMap model,
      RedirectAttributes attr) {
<span class="nc" id="L205">    return condutorService.buscarPorNumOrdem(numOrdem)</span>
<span class="nc" id="L206">        .filter(condutor -&gt; {</span>
<span class="nc" id="L207">          LocalDate vencimento = condutor.getDataVencimentoAlvara();</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">          return vencimento != null &amp;&amp; !vencimento.isBefore(LocalDate.now());</span>
        })
<span class="nc" id="L210">        .map(condutor -&gt; {</span>
<span class="nc" id="L211">          model.addAttribute(&quot;condutores&quot;, List.of(condutor));</span>
<span class="nc" id="L212">          return &quot;cliente/lista-condutores&quot;;</span>
        })
<span class="nc" id="L214">        .orElseGet(() -&gt; {</span>
<span class="nc" id="L215">          attr.addFlashAttribute(&quot;fail&quot;, &quot;Número de ordem não existe ou o alvará está vencido!&quot;);</span>
<span class="nc" id="L216">          return &quot;redirect:/clientes/condutores&quot;;</span>
        });
  }

  /**
   * Endpoint responsável por registrar automaticamente um contato entre o cliente
   * autenticado
   * e o condutor selecionado.
   * &lt;p&gt;
   * Esse método é acionado assim que o cliente clica no botão de envio de
   * mensagem via WhatsApp,
   * registrando no banco de dados informações relevantes sobre o cliente e o
   * condutor no momento do contato.
   * &lt;/p&gt;
   *
   * @param payload Mapa contendo o identificador do condutor ({@code condutorId})
   *                enviado pelo cliente.
   * @param user    Objeto de autenticação contendo os dados do usuário logado.
   * @return {@code 200 OK} indicando que o registro foi persistido com sucesso.
   *
   * @since 1.0
   * @see br.gov.ba.saj.smtt.cadmototaxistas.auditoria.service.RegistroClienteContato.impl.RegistroClienteContatoServiceImpl#salvar(Long,
   *      String)
   */
  @ResponseBody
  @PostMapping(&quot;/registrar-contato&quot;)
  public ResponseEntity&lt;Void&gt; registrarContato(@RequestBody Map&lt;String, Long&gt; payload,
      @AuthenticationPrincipal User user) {
<span class="nc" id="L244">    Long condutorId = payload.get(&quot;condutorId&quot;);</span>
<span class="nc" id="L245">    LOGGER.info(&quot;Registrando contato do cliente {} com o condutor ID: {}&quot;, user.getUsername(), condutorId);</span>
<span class="nc" id="L246">    registroClienteContatoService.salvar(condutorId, user.getUsername());</span>
<span class="nc" id="L247">    return ResponseEntity.ok().build();</span>
  }

  @GetMapping(&quot;/historico-contato&quot;)
  @PreAuthorize(&quot;hasAuthority('CLIENTE')&quot;)
  public String listarHistoricoDeContatos(ModelMap model, @RequestParam(&quot;page&quot;) Optional&lt;Integer&gt; page,
      @RequestParam(&quot;dir&quot;) Optional&lt;String&gt; dir, @AuthenticationPrincipal User user,
      RedirectAttributes attr) {
<span class="nc" id="L255">    Optional&lt;Cliente&gt; cliente = clienteService.buscarPorUsuarioEmail(user.getUsername());</span>

<span class="nc bnc" id="L257" title="All 4 branches missed.">    if (cliente.isEmpty() || cliente.get().getNome() == null) {</span>
<span class="nc" id="L258">      attr.addFlashAttribute(&quot;fail&quot;,</span>
          &quot;Você precisa preencher seus dados antes de listar historico de contatos com condutores.&quot;);
<span class="nc" id="L260">      return &quot;redirect:/clientes/dados&quot;;</span>
    }

<span class="nc" id="L263">    int paginaAtual = page.orElse(1);</span>
<span class="nc" id="L264">    String ordem = dir.orElse(&quot;asc&quot;);</span>
<span class="nc" id="L265">    PaginacaoUtil&lt;RegistroClienteContato&gt; pageRegistroClienteContato = registroClienteContatoService</span>
<span class="nc" id="L266">        .buscaPaginada(cliente.get().getId(), paginaAtual, ordem);</span>
<span class="nc" id="L267">    model.addAttribute(&quot;pageRegistroClienteContato&quot;, pageRegistroClienteContato);</span>
<span class="nc" id="L268">    return &quot;cliente/historico-contato&quot;;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>